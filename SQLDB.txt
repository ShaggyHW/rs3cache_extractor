-- ========== TABLES ==========

--CREATE TABLE IF NOT EXISTS abstract_teleport_edges (
--  edge_id INTEGER PRIMARY KEY,
--  kind TEXT NOT NULL
--       CHECK (kind IN ('door','lodestone','npc','object','item','ifslot')),
--  node_id INTEGER NOT NULL,

--  -- abstract graph geometry
--  src_x INTEGER,
--  src_y INTEGER,
--  src_plane INTEGER,
--  dst_x INTEGER NOT NULL,
--  dst_y INTEGER NOT NULL,
--  dst_plane INTEGER NOT NULL,

--  -- planning metadata
--  cost INTEGER NOT NULL CHECK (cost >= 0),
--  requirements TEXT,
--  src_entrance INTEGER,
--  dst_entrance INTEGER,

--  -- ensure one concrete node maps to at most one abstract edge
--  UNIQUE(kind, node_id)
--);

--CREATE TABLE clusters (
--    cluster_id INTEGER PRIMARY KEY,
--    plane INTEGER NOT NULL,
--    label INTEGER,
--    tile_count INTEGER
--);

--CREATE TABLE cluster_entrances (
--    entrance_id INTEGER PRIMARY KEY,
--    cluster_id INTEGER NOT NULL REFERENCES clusters(cluster_id),
--    x INTEGER NOT NULL,
--    y INTEGER NOT NULL,
--    plane INTEGER NOT NULL,
--    neighbor_dir TEXT NOT NULL CHECK (neighbor_dir IN ('N','S','E','W','TP')),
--    teleport_edge_id INTEGER REFERENCES abstract_teleport_edges(edge_id),
--    UNIQUE (cluster_id, x, y, plane, neighbor_dir)
--);

--CREATE TABLE cluster_interconnections (
--    entrance_from INTEGER NOT NULL,
--    entrance_to INTEGER NOT NULL,
--    cost INTEGER NOT NULL,
--    PRIMARY KEY (entrance_from, entrance_to),
--    FOREIGN KEY (entrance_from) REFERENCES cluster_entrances(entrance_id),
--    FOREIGN KEY (entrance_to) REFERENCES cluster_entrances(entrance_id),
--    CONSTRAINT chk_cc_cost_nonneg CHECK (cost >= 0)
--);

--CREATE TABLE cluster_intraconnections (
--    entrance_from INTEGER NOT NULL,
--    entrance_to INTEGER NOT NULL,
--    cost INTEGER NOT NULL,
--    path_blob BLOB,
--    PRIMARY KEY (entrance_from, entrance_to),
--    FOREIGN KEY (entrance_from) REFERENCES cluster_entrances(entrance_id),
--    FOREIGN KEY (entrance_to) REFERENCES cluster_entrances(entrance_id),
--     CONSTRAINT chk_ci_cost_nonneg CHECK (cost >= 0)
--);

--CREATE TABLE cluster_tiles (
--    cluster_id INTEGER NOT NULL REFERENCES clusters(cluster_id),
--    x INTEGER NOT NULL,
--    y INTEGER NOT NULL,
--    plane INTEGER NOT NULL,
--    PRIMARY KEY (cluster_id, x, y, plane)
--);

--CREATE TABLE meta (
--  key   TEXT PRIMARY KEY
--        CHECK (key IN (
--          'schema_version','tileset_version','map_build_at',
--          'generator_commit', 'coordinate_origin'
--        )),
--  value TEXT NOT NULL
--);


CREATE TABLE teleports_door_nodes (
    id INTEGER PRIMARY KEY,
    direction TEXT,
    real_id_open INTEGER,
    real_id_closed INTEGER,
    location_open_x INTEGER,
    location_open_y INTEGER,
    location_open_plane INTEGER,
    location_closed_x INTEGER,
    location_closed_y INTEGER,
    location_closed_plane INTEGER,
    tile_inside_x INTEGER,
    tile_inside_y INTEGER,
    tile_inside_plane INTEGER,
    tile_outside_x INTEGER,
    tile_outside_y INTEGER,
    tile_outside_plane INTEGER,
    open_action TEXT,
    cost INTEGER,
    next_node_type TEXT,
    next_node_id INTEGER,
    requirements TEXT
);

CREATE TABLE teleports_ifslot_nodes (
    id INTEGER PRIMARY KEY,
    interface_id INTEGER,
    component_id INTEGER,
    slot_id INTEGER,
    click_id INTEGER,
    dest_min_x INTEGER,
    dest_max_x INTEGER,
    dest_min_y INTEGER,
    dest_max_y INTEGER,
    dest_plane INTEGER,
    cost INTEGER,
    next_node_type TEXT,
    next_node_id INTEGER,
    requirements TEXT
);

CREATE TABLE teleports_item_nodes (
    id INTEGER PRIMARY KEY,
    match_type TEXT,
    name TEXT,
    item_id INTEGER,
    action TEXT,
    dest_min_x INTEGER,
    dest_max_x INTEGER,
    dest_min_y INTEGER,
    dest_max_y INTEGER,
    dest_plane INTEGER,
    next_node_type TEXT,
    next_node_id INTEGER,
    cost INTEGER,
    requirements TEXT
);

CREATE TABLE teleports_lodestone_nodes (
    id INTEGER PRIMARY KEY,
    lodestone TEXT,
    dest_x INTEGER,
    dest_y INTEGER,
    dest_plane INTEGER,
    cost INTEGER,
    next_node_type TEXT,
    next_node_id INTEGER,
    requirements TEXT
);

CREATE TABLE teleports_npc_nodes (
    id INTEGER PRIMARY KEY,
    match_type TEXT,
    npc_id INTEGER,
    npc_name TEXT,
    action TEXT,
    dest_min_x INTEGER,
    dest_max_x INTEGER,
    dest_min_y INTEGER,
    dest_max_y INTEGER,
    dest_plane INTEGER,
    search_radius INTEGER,
    cost INTEGER,
    orig_min_x INTEGER,
    orig_max_x INTEGER,
    orig_min_y INTEGER,
    orig_max_y INTEGER,
    orig_plane INTEGER,
    next_node_type TEXT,
    next_node_id INTEGER,
    requirements TEXT
);

CREATE TABLE teleports_object_nodes (
    id INTEGER PRIMARY KEY,
    match_type TEXT,
    object_id INTEGER,
    object_name TEXT,
    action TEXT,
    dest_min_x INTEGER,
    dest_max_x INTEGER,
    dest_min_y INTEGER,
    dest_max_y INTEGER,
    dest_plane INTEGER,
    orig_min_x INTEGER,
    orig_max_x INTEGER,
    orig_min_y INTEGER,
    orig_max_y INTEGER,
    orig_plane INTEGER,
    search_radius INTEGER,
    cost INTEGER,
    next_node_type TEXT,
    next_node_id INTEGER,
    requirements TEXT
);

CREATE TABLE teleports_requirements (
    id INTEGER PRIMARY KEY,
    metaInfo TEXT,
    key TEXT,
    value TEXT,
    comparison TEXT
);

CREATE TABLE tiles (
    x INTEGER,
    y INTEGER,
    plane INTEGER,
    walk_mask INTEGER,
    RegionID INTEGER,
    PRIMARY KEY (x, y, plane)
);

-- ========== INDEXES ==========

--CREATE INDEX IF NOT EXISTS idx_abstract_teleport_dst
--  ON abstract_teleport_edges(dst_plane, dst_x, dst_y);

--CREATE INDEX IF NOT EXISTS idx_abstract_teleport_src
--  ON abstract_teleport_edges(src_plane, src_x, src_y);

--CREATE INDEX idx_cluster_entrances_plane_xy
--    ON cluster_entrances(plane, x, y);

--CREATE INDEX idx_cluster_inter_to
--    ON cluster_interconnections(entrance_to);

-- updated to reflect new key for cluster_intraconnections
--CREATE INDEX idx_cluster_intra_from_to
--    ON cluster_intraconnections(entrance_from, entrance_to);

-- removed: idx_tiles_chunk / idx_tiles_chunk_boundary (chunk-based)
CREATE INDEX idx_tiles_walkable
    ON tiles(x, y, plane);

--CREATE INDEX idx_tiles_xyplane
--    ON tiles(x, y, plane);

--CREATE INDEX IF NOT EXISTS idx_cluster_tiles_xyplane
--  ON cluster_tiles(plane, x, y);

--CREATE INDEX IF NOT EXISTS idx_cluster_entrances_cluster_dir
--  ON cluster_entrances(cluster_id, neighbor_dir);

--CREATE INDEX IF NOT EXISTS idx_ate_kind_node
--  ON abstract_teleport_edges(kind, node_id);
CREATE INDEX IF NOT EXISTS idx_teleport_req_all
  ON teleports_requirements(id); -- lookup by id
--CREATE INDEX IF NOT EXISTS idx_ate_requirement
--  ON abstract_teleport_edges(requirements);
CREATE INDEX IF NOT EXISTS idx_tdoor_req ON teleports_door_nodes(requirements);
CREATE INDEX IF NOT EXISTS idx_tnpc_req  ON teleports_npc_nodes(requirements);
CREATE INDEX IF NOT EXISTS idx_tobj_req  ON teleports_object_nodes(requirements);
CREATE INDEX IF NOT EXISTS idx_titem_req ON teleports_item_nodes(requirements);
CREATE INDEX IF NOT EXISTS idx_tif_req   ON teleports_ifslot_nodes(requirements);
CREATE INDEX IF NOT EXISTS idx_tlode_req ON teleports_lodestone_nodes(requirements);

-- ========== VIEW ==========

CREATE VIEW teleports_all AS
SELECT 'door' AS kind, id,
       tile_outside_x AS src_x, tile_outside_y AS src_y, tile_outside_plane AS src_plane,
       tile_inside_x AS dst_x, tile_inside_y AS dst_y, tile_inside_plane AS dst_plane,
       cost, requirements
FROM teleports_door_nodes
UNION ALL
SELECT 'lodestone', id, NULL, NULL, NULL,
       dest_x, dest_y, dest_plane, cost, requirements
FROM teleports_lodestone_nodes
UNION ALL
SELECT 'npc', id, orig_min_x, orig_min_y, orig_plane,
       dest_min_x, dest_min_y, dest_plane, cost, requirements
FROM teleports_npc_nodes
UNION ALL
SELECT 'object', id, orig_min_x, orig_min_y, orig_plane,
       dest_min_x, dest_min_y, dest_plane, cost, requirements
FROM teleports_object_nodes
UNION ALL
SELECT 'item', id, NULL, NULL, NULL,
       dest_min_x, dest_min_y, dest_plane, cost, requirements
FROM teleports_item_nodes
UNION ALL
SELECT 'ifslot', id, NULL, NULL, NULL,
       CAST(dest_min_x AS INTEGER), CAST(dest_min_y AS INTEGER),
       CAST(dest_plane AS INTEGER), cost, requirements
FROM teleports_ifslot_nodes
WHERE dest_min_x IS NOT NULL;